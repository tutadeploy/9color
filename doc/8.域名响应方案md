# åŸŸååŠ¨æ€åˆ‡æ¢è§£å†³æ–¹æ¡ˆ

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–¹æ¡ˆåŸºäº **Cloudflare + ihosting + PHP + Nginx** æŠ€æœ¯æ ˆï¼Œå®ç°ä¸‰å±‚åŸŸååŠ¨æ€åˆ‡æ¢æ¶æ„ï¼Œç¡®ä¿åœ¨åŸŸåè¢«å°é”æˆ–æœåŠ¡å¼‚å¸¸æ—¶èƒ½å¤Ÿå¿«é€Ÿåˆ‡æ¢åˆ°å¤‡ç”¨åŸŸåï¼Œä¿è¯æœåŠ¡çš„æŒç»­å¯ç”¨æ€§ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

æœ¬æ–‡æ¡£æä¾›åŸºç¡€çš„åŸŸååˆ‡æ¢æ¶æ„å’Œå®ç°ä»£ç ã€‚æ ¹æ®æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œè¯·é€‰æ‹©å¯¹åº”çš„é…ç½®æ–¹æ¡ˆï¼š

- ğŸ“– **`doc/9.CFé…ç½®.md`** - å•åŸŸåå­åŸŸååˆ‡æ¢çš„Cloudflareé…ç½®
- ğŸ“– **`doc/10.å¤šåŸŸåé›†æˆæ–¹æ¡ˆ.md`** - å¤šä¸ªä¸åŒåŸŸåçš„å®Œæ•´åˆ‡æ¢æ–¹æ¡ˆ

## ğŸ¯ é€‚ç”¨åœºæ™¯

### åŸºç¡€æ¶æ„ï¼ˆæœ¬æ–‡æ¡£ï¼‰ï¼š
- âœ… æä¾›å®Œæ•´çš„ä¸‰å±‚åˆ‡æ¢æ¶æ„è®¾è®¡
- âœ… å®¢æˆ·ç«¯JavaScriptæ™ºèƒ½åˆ‡æ¢å™¨
- âœ… PHPå¥åº·æ£€æŸ¥API
- âœ… Nginxé…ç½®ä¼˜åŒ–
- âœ… ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### å•åŸŸåæ–¹æ¡ˆï¼ˆ9.CFé…ç½®.mdï¼‰ï¼š
- ğŸ—ï¸ main.yourdomain.com â†” backup1.yourdomain.com
- ğŸ—ï¸ é€‚åˆç›¸åŒåŸŸåçš„å­åŸŸååˆ‡æ¢

### å¤šåŸŸåæ–¹æ¡ˆï¼ˆ10.å¤šåŸŸåé›†æˆæ–¹æ¡ˆ.mdï¼‰ï¼š
- ğŸŒ domain1.com â†” domain2.net â†” domain3.org
- ğŸŒ é€‚åˆå®Œå…¨ä¸åŒåŸŸåçš„è·¨åŸŸåˆ‡æ¢

## æŠ€æœ¯æ¶æ„

```
ç”¨æˆ·è¯·æ±‚ â†’ å®¢æˆ·ç«¯JSæ™ºèƒ½åˆ‡æ¢ â†’ Cloudflare DNSæ•…éšœè½¬ç§» â†’ ihosting Nginxè·¯ç”± â†’ PHPåº”ç”¨
    â†“              â†“                    â†“                  â†“            â†“
  ç§’çº§åˆ‡æ¢      åŸŸåæ± ç®¡ç†          ä¸“ä¸šDNSæœåŠ¡        è´Ÿè½½å‡è¡¡      ä¸šåŠ¡é€»è¾‘
```

### ä¸‰å±‚é˜²æŠ¤æœºåˆ¶

1. **ç¬¬ä¸€å±‚ï¼šå®¢æˆ·ç«¯JavaScriptæ™ºèƒ½æ•…éšœè½¬ç§»**
   - å®æ—¶åŸŸåå¥åº·æ£€æŸ¥
   - æ¯«ç§’çº§åŸŸååˆ‡æ¢
   - æœ¬åœ°ç¼“å­˜æœ€ä½³åŸŸå

2. **ç¬¬äºŒå±‚ï¼šCloudflare DNSæ•…éšœè½¬ç§»**
   - ä¸“ä¸šDNSæœåŠ¡ä¿éšœ
   - å…¨çƒå¥åº·æ£€æŸ¥
   - è‡ªåŠ¨DNSè®°å½•åˆ‡æ¢

3. **ç¬¬ä¸‰å±‚ï¼šihosting Nginxè·¯ç”±ä¼˜åŒ–**
   - æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡
   - å¤šåŸŸåç»Ÿä¸€å¤„ç†
   - æ€§èƒ½ç›‘æ§ä¸æ—¥å¿—

## æ ¸å¿ƒä¼˜åŠ¿

- âš¡ **å“åº”é€Ÿåº¦å¿«**: å®¢æˆ·ç«¯åˆ‡æ¢ < 1ç§’ï¼ŒDNSåˆ‡æ¢ < 5åˆ†é’Ÿ
- ğŸ›¡ï¸ **é«˜å¯ç”¨æ€§**: 99.999% å¯ç”¨æ€§ä¿è¯
- ğŸ’° **æˆæœ¬å¯æ§**: åˆ©ç”¨ç°æœ‰åŸºç¡€è®¾æ–½ï¼Œå¢é‡æˆæœ¬ä½
- ğŸ”§ **æ˜“äºç»´æŠ¤**: è‡ªåŠ¨åŒ–ç›‘æ§ï¼Œç®€åŒ–è¿ç»´
- ğŸŒ **å…¨çƒä¼˜åŒ–**: åŸºäºåœ°ç†ä½ç½®çš„æ™ºèƒ½è·¯ç”±

---

## å®ç°æ–¹æ¡ˆè¯¦ç»†ä»£ç 

### 1. å®¢æˆ·ç«¯JavaScriptæ™ºèƒ½æ•…éšœè½¬ç§»

#### 1.1 åŸŸååˆ‡æ¢æ ¸å¿ƒç±»

**æ–‡ä»¶è·¯å¾„**: `public/static/js/domain-switcher.js`

```javascript
class DomainSwitcher {
    constructor() {
        this.domains = [
            'main.yourdomain.com',      // ä¸»åŸŸå
            'backup1.yourdomain.com',   // å¤‡ç”¨åŸŸå1  
            'backup2.yourdomain.com',   // å¤‡ç”¨åŸŸå2
            'backup3.yourdomain.com'    // å¤‡ç”¨åŸŸå3
        ];
        
        this.currentDomainIndex = 0;
        this.healthCheckTimeout = 5000; // 5ç§’è¶…æ—¶
        this.retryInterval = 30000;     // 30ç§’é‡è¯•é—´éš”
        this.maxRetries = 3;
        
        this.init();
    }
    
    init() {
        // ä»localStorageè·å–ä¸Šæ¬¡å¯ç”¨çš„åŸŸå
        const savedDomain = localStorage.getItem('activeDomain');
        if (savedDomain && this.domains.includes(savedDomain)) {
            this.currentDomainIndex = this.domains.indexOf(savedDomain);
        }
        
        this.startHealthCheck();
        this.interceptAjaxFailures();
    }
    
    async checkDomainHealth(domain) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout);
            
            const response = await fetch(`https://${domain}/api/health`, {
                method: 'GET',
                signal: controller.signal,
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            clearTimeout(timeoutId);
            return response.ok && response.status === 200;
        } catch (error) {
            console.log(`Domain ${domain} health check failed:`, error.message);
            return false;
        }
    }
    
    async findBestDomain() {
        // å…ˆæ£€æŸ¥å½“å‰åŸŸå
        const currentDomain = this.domains[this.currentDomainIndex];
        if (await this.checkDomainHealth(currentDomain)) {
            return currentDomain;
        }
        
        // éå†å…¶ä»–åŸŸåå¯»æ‰¾å¯ç”¨çš„
        for (let i = 0; i < this.domains.length; i++) {
            if (i === this.currentDomainIndex) continue;
            
            if (await this.checkDomainHealth(this.domains[i])) {
                this.currentDomainIndex = i;
                localStorage.setItem('activeDomain', this.domains[i]);
                this.logDomainSwitch(this.domains[i]);
                return this.domains[i];
            }
        }
        
        return null;
    }
    
    async switchToNextDomain() {
        const bestDomain = await this.findBestDomain();
        
        if (bestDomain && bestDomain !== window.location.hostname) {
            // ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€
            this.saveCurrentState();
            
            // åˆ‡æ¢åˆ°æ–°åŸŸå
            const newUrl = `https://${bestDomain}${window.location.pathname}${window.location.search}`;
            console.log(`Switching to domain: ${bestDomain}`);
            window.location.href = newUrl;
            return true;
        }
        
        return false;
    }
    
    startHealthCheck() {
        setInterval(async () => {
            const currentDomain = window.location.hostname;
            const isHealthy = await this.checkDomainHealth(currentDomain);
            
            if (!isHealthy) {
                console.log('Current domain unhealthy, attempting switch...');
                await this.switchToNextDomain();
            }
        }, this.retryInterval);
    }
    
    interceptAjaxFailures() {
        const originalFetch = window.fetch;
        const self = this;
        
        window.fetch = async function(...args) {
            let retryCount = 0;
            
            while (retryCount < self.maxRetries) {
                try {
                    const response = await originalFetch.apply(this, args);
                    if (response.ok) {
                        return response;
                    }
                    
                    // å¦‚æœæ˜¯æœåŠ¡å™¨é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢åŸŸå
                    if (response.status >= 500) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return response;
                } catch (error) {
                    retryCount++;
                    console.log(`Fetch attempt ${retryCount} failed:`, error.message);
                    
                    if (retryCount >= self.maxRetries) {
                        // æœ€åä¸€æ¬¡å°è¯•ï¼Œåˆ‡æ¢åŸŸå
                        const switched = await self.switchToNextDomain();
                        if (!switched) {
                            throw error;
                        }
                        return; // é¡µé¢å°†é‡å®šå‘
                    }
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                    await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                }
            }
        };
    }
    
    saveCurrentState() {
        // ä¿å­˜ç”¨æˆ·å½“å‰çŠ¶æ€ï¼Œä¾¿äºåˆ‡æ¢åæ¢å¤
        const state = {
            timestamp: Date.now(),
            path: window.location.pathname,
            search: window.location.search,
            referrer: document.referrer
        };
        localStorage.setItem('pageState', JSON.stringify(state));
    }
    
    logDomainSwitch(newDomain) {
        // è®°å½•åŸŸååˆ‡æ¢æ—¥å¿—
        const log = {
            timestamp: new Date().toISOString(),
            from: window.location.hostname,
            to: newDomain,
            userAgent: navigator.userAgent,
            url: window.location.href
        };
        
        // å‘é€åˆ‡æ¢æ—¥å¿—åˆ°æœåŠ¡å™¨
        this.sendSwitchLog(log);
    }
    
    async sendSwitchLog(logData) {
        try {
            await fetch('/api/log-domain-switch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(logData)
            });
        } catch (error) {
            console.log('Failed to send switch log:', error);
        }
    }
}

// å…¨å±€åˆå§‹åŒ–
window.domainSwitcher = new DomainSwitcher();

// é¡µé¢åŠ è½½å®Œæˆåé¢å¤–æ£€æŸ¥
document.addEventListener('DOMContentLoaded', function() {
    // æ¢å¤é¡µé¢çŠ¶æ€
    const savedState = localStorage.getItem('pageState');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            // å¦‚æœæ˜¯æœ€è¿‘çš„åˆ‡æ¢(5åˆ†é’Ÿå†…)ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›æ¢å¤æ“ä½œ
            if (Date.now() - state.timestamp < 300000) {
                console.log('Restored from domain switch:', state);
            }
            localStorage.removeItem('pageState');
        } catch (error) {
            console.log('Failed to restore state:', error);
        }
    }
});
```

#### 1.2 é¡µé¢é›†æˆä»£ç 

**åœ¨ä¸»æ¨¡æ¿ä¸­æ·»åŠ **:

```html
<!-- åœ¨ <head> æ ‡ç­¾ä¸­æ·»åŠ  -->
<script src="/static/js/domain-switcher.js" defer></script>

<!-- å¯é€‰ï¼šæ˜¾ç¤ºå½“å‰åŸŸåçŠ¶æ€ -->
<div id="domain-status" style="position: fixed; top: 10px; right: 10px; z-index: 9999; 
     background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px;">
    å½“å‰åŸŸåæ­£å¸¸
</div>

<script>
// æ˜¾ç¤ºåŸŸåçŠ¶æ€
function updateDomainStatus() {
    const statusEl = document.getElementById('domain-status');
    if (statusEl && window.domainSwitcher) {
        const currentDomain = window.location.hostname;
        window.domainSwitcher.checkDomainHealth(currentDomain).then(isHealthy => {
            statusEl.textContent = isHealthy ? 'åŸŸåæ­£å¸¸' : 'æ£€æµ‹åˆ‡æ¢ä¸­...';
            statusEl.style.backgroundColor = isHealthy ? '#28a745' : '#dc3545';
        });
    }
}

// æ¯30ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€æ˜¾ç¤º
setInterval(updateDomainStatus, 30000);
updateDomainStatus();
</script>
```

### 2. PHPåç«¯å¥åº·æ£€æŸ¥API

#### 2.1 å¥åº·æ£€æŸ¥æ§åˆ¶å™¨

**æ–‡ä»¶è·¯å¾„**: `application/index/controller/Health.php`

```php
<?php
namespace app\index\controller;

use think\Controller;
use think\Response;
use think\Db;
use think\Cache;

class Health extends Controller
{
    /**
     * å¥åº·æ£€æŸ¥æ¥å£
     * ç”¨äºå®¢æˆ·ç«¯æ£€æµ‹åŸŸåå¯ç”¨æ€§
     */
    public function index()
    {
        $startTime = microtime(true);
        
        // æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥
        $healthStatus = $this->performHealthChecks();
        
        $responseTime = round((microtime(true) - $startTime) * 1000, 2);
        
        $responseData = [
            'status' => $healthStatus['healthy'] ? 'healthy' : 'unhealthy',
            'timestamp' => time(),
            'server' => [
                'hostname' => gethostname(),
                'domain' => $_SERVER['HTTP_HOST'] ?? '',
                'ip' => $_SERVER['SERVER_ADDR'] ?? '',
            ],
            'response_time_ms' => $responseTime,
            'checks' => $healthStatus['checks'],
            'version' => '1.0.0'
        ];
        
        if (!$healthStatus['healthy']) {
            $responseData['errors'] = $healthStatus['errors'];
        }
        
        $httpStatus = $healthStatus['healthy'] ? 200 : 503;
        
        return Response::create($responseData, 'json', $httpStatus)
            ->header([
                'Cache-Control' => 'no-cache, no-store, must-revalidate',
                'Pragma' => 'no-cache',
                'Expires' => '0',
                'Access-Control-Allow-Origin' => '*',
                'Access-Control-Allow-Methods' => 'GET, OPTIONS',
                'Access-Control-Allow-Headers' => 'Content-Type, Authorization'
            ]);
    }
    
    /**
     * åŸŸååˆ‡æ¢æ—¥å¿—è®°å½•
     */
    public function logDomainSwitch()
    {
        if ($this->request->isPost()) {
            $logData = $this->request->param();
            
            // è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
            $this->writeSwitchLog($logData);
            
            return Response::create([
                'status' => 'success',
                'message' => 'Log recorded'
            ], 'json', 200);
        }
        
        return Response::create([
            'status' => 'error', 
            'message' => 'Method not allowed'
        ], 'json', 405);
    }
    
    /**
     * æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥
     */
    private function performHealthChecks()
    {
        $checks = [];
        $errors = [];
        $healthy = true;
        
        // 1. æ•°æ®åº“è¿æ¥æ£€æŸ¥
        try {
            $result = Db::query('SELECT 1 as test');
            $checks['database'] = [
                'status' => 'ok',
                'message' => 'Database connection successful'
            ];
        } catch (\Exception $e) {
            $checks['database'] = [
                'status' => 'failed',
                'message' => 'Database connection failed: ' . $e->getMessage()
            ];
            $errors[] = 'Database connection failed';
            $healthy = false;
        }
        
        // 2. ç¼“å­˜æœåŠ¡æ£€æŸ¥
        try {
            Cache::set('health_check', time(), 60);
            $cacheTest = Cache::get('health_check');
            $checks['cache'] = [
                'status' => 'ok',
                'message' => 'Cache service working'
            ];
        } catch (\Exception $e) {
            $checks['cache'] = [
                'status' => 'warning',
                'message' => 'Cache service unavailable: ' . $e->getMessage()
            ];
            // ç¼“å­˜å¤±è´¥ä¸å½±å“æ•´ä½“å¥åº·çŠ¶æ€
        }
        
        // 3. ç£ç›˜ç©ºé—´æ£€æŸ¥
        $freeSpace = disk_free_space('/');
        $totalSpace = disk_total_space('/');
        $usagePercent = (($totalSpace - $freeSpace) / $totalSpace) * 100;
        
        if ($usagePercent > 95) {
            $checks['disk'] = [
                'status' => 'critical',
                'usage_percent' => round($usagePercent, 2),
                'message' => 'Disk usage critical'
            ];
            $errors[] = 'Disk usage over 95%';
            $healthy = false;
        } elseif ($usagePercent > 85) {
            $checks['disk'] = [
                'status' => 'warning',
                'usage_percent' => round($usagePercent, 2),
                'message' => 'Disk usage high'
            ];
        } else {
            $checks['disk'] = [
                'status' => 'ok',
                'usage_percent' => round($usagePercent, 2),
                'message' => 'Disk usage normal'
            ];
        }
        
        // 4. PHP-FPMçŠ¶æ€æ£€æŸ¥
        $checks['php_fpm'] = [
            'status' => 'ok',
            'memory_usage' => round(memory_get_usage(true) / 1024 / 1024, 2) . 'MB',
            'memory_peak' => round(memory_get_peak_usage(true) / 1024 / 1024, 2) . 'MB'
        ];
        
        // 5. è´Ÿè½½æ£€æŸ¥
        if (function_exists('sys_getloadavg')) {
            $load = sys_getloadavg();
            $checks['system_load'] = [
                'status' => $load[0] > 10 ? 'warning' : 'ok',
                'load_1min' => $load[0],
                'load_5min' => $load[1],
                'load_15min' => $load[2]
            ];
        }
        
        return [
            'healthy' => $healthy,
            'checks' => $checks,
            'errors' => $errors
        ];
    }
    
    /**
     * è®°å½•åŸŸååˆ‡æ¢æ—¥å¿—
     */
    private function writeSwitchLog($logData)
    {
        $logEntry = [
            'timestamp' => date('Y-m-d H:i:s'),
            'client_ip' => $this->request->ip(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'from_domain' => $logData['from'] ?? '',
            'to_domain' => $logData['to'] ?? '',
            'url' => $logData['url'] ?? '',
            'referrer' => $logData['referrer'] ?? ''
        ];
        
        $logFile = ROOT_PATH . 'runtime/log/domain_switches.log';
        $logLine = json_encode($logEntry) . "\n";
        
        file_put_contents($logFile, $logLine, FILE_APPEND | LOCK_EX);
    }
}
```

#### 2.2 è·¯ç”±é…ç½®

**æ–‡ä»¶è·¯å¾„**: `route/route.php`

```php
<?php
// å¥åº·æ£€æŸ¥è·¯ç”±
Route::get('api/health', 'index/Health/index');
Route::post('api/log-domain-switch', 'index/Health/logDomainSwitch');

// æ”¯æŒCORSé¢„æ£€è¯·æ±‚
Route::rule('api/health', 'index/Health/index', 'OPTIONS');
Route::rule('api/log-domain-switch', 'index/Health/logDomainSwitch', 'OPTIONS');
```

### 3. Nginxé…ç½®ä¼˜åŒ–

#### 3.1 ä¸»é…ç½®æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**: `nginx-php73-production/nginx/conf.d/default.conf`

```nginx
# ä¸Šæ¸¸æœåŠ¡å™¨å®šä¹‰
upstream backend_servers {
    server 127.0.0.1:9000;  # PHP-FPM
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;
}

# åŸŸåæ˜ å°„é…ç½®
map $host $backend_pool {
    default                  backend_servers;
    ~^main\.                backend_servers;
    ~^backup1\.             backend_servers;
    ~^backup2\.             backend_servers;
    ~^backup3\.             backend_servers;
}

# å®æ—¶IPæ£€æµ‹
map $http_x_forwarded_for $real_ip {
    default $remote_addr;
    ~^(\d+\.\d+\.\d+\.\d+) $1;
}

# é€Ÿç‡é™åˆ¶é…ç½®
limit_req_zone $real_ip zone=api:10m rate=10r/s;
limit_req_zone $real_ip zone=general:10m rate=50r/s;
limit_req_zone $real_ip zone=health:10m rate=5r/s;

# ä¸»æœåŠ¡å™¨é…ç½®
server {
    listen 80;
    listen 443 ssl http2;
    
    # æ”¯æŒå¤šåŸŸå
    server_name 
        main.yourdomain.com
        backup1.yourdomain.com  
        backup2.yourdomain.com
        backup3.yourdomain.com;
    
    # SSLé…ç½® (æ”¯æŒCloudflare)
    ssl_certificate     /etc/nginx/ssl/cloudflare.pem;
    ssl_certificate_key /etc/nginx/ssl/cloudflare.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:DHE+AES128:!aNULL:!MD5:!DSS;
    ssl_prefer_server_ciphers on;
    
    root /var/www/html/public;
    index index.php index.html;
    
    # åŸŸååˆ‡æ¢æ—¥å¿—æ ¼å¼
    log_format domain_access '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for" '
                            'domain="$host" response_time=$request_time';
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¼˜åŒ–
    location = /api/health {
        limit_req zone=health burst=10 nodelay;
        
        # è·¨åŸŸæ”¯æŒ
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        # OPTIONSè¯·æ±‚ç›´æ¥è¿”å›
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        
        try_files $uri /index.php$is_args$args;
    }
    
    # åŸŸååˆ‡æ¢æ—¥å¿—æ¥å£
    location = /api/log-domain-switch {
        limit_req zone=api burst=5 nodelay;
        
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        try_files $uri /index.php$is_args$args;
    }
    
    # é™æ€èµ„æºä¼˜åŒ–
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        add_header Access-Control-Allow-Origin "*";
        
        # Gzipå‹ç¼©
        gzip_static on;
    }
    
    # PHPè¯·æ±‚å¤„ç†
    location ~ \.php$ {
        limit_req zone=general burst=50 nodelay;
        
        fastcgi_pass backend_servers;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param HTTPS $https if_not_empty;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        
        include fastcgi_params;
    }
    
    # é»˜è®¤location
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }
    
    # å®‰å…¨é…ç½®
    location ~ /\. {
        deny all;
    }
    
    location ~ /(config|runtime|application)/ {
        deny all;
    }
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/domain_access.log domain_access;
    error_log /var/log/nginx/domain_error.log warn;
    
    # å®‰å…¨å¤´è®¾ç½®
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # éšè—æœåŠ¡å™¨ä¿¡æ¯
    server_tokens off;
}

# HTTPåˆ°HTTPSé‡å®šå‘
server {
    listen 80;
    server_name 
        main.yourdomain.com
        backup1.yourdomain.com
        backup2.yourdomain.com
        backup3.yourdomain.com;
    
    # å¥åº·æ£€æŸ¥ä¸é‡å®šå‘
    location = /api/health {
        try_files $uri /index.php$is_args$args;
    }
    
    # å…¶ä»–è¯·æ±‚é‡å®šå‘åˆ°HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}
```

### 4. ç›‘æ§å’Œæ—¥å¿—åˆ†æ

#### 4.1 åŸŸåç›‘æ§è„šæœ¬

**æ–‡ä»¶è·¯å¾„**: `scripts/domain-monitor.php`

```php
<?php
require_once __DIR__ . '/../vendor/autoload.php';

class DomainMonitor {
    private $domains;
    private $logFile;
    private $alertWebhook;
    
    public function __construct() {
        $this->domains = [
            'main.yourdomain.com',
            'backup1.yourdomain.com',
            'backup2.yourdomain.com', 
            'backup3.yourdomain.com'
        ];
        
        $this->logFile = __DIR__ . '/logs/domain_monitor.log';
        $this->alertWebhook = 'YOUR_WEBHOOK_URL'; // å¯é€‰ï¼šå‘Šè­¦webhook
        
        // ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        $logDir = dirname($this->logFile);
        if (!is_dir($logDir)) {
            mkdir($logDir, 0755, true);
        }
    }
    
    public function checkAllDomains() {
        $results = [];
        $healthyCount = 0;
        
        foreach ($this->domains as $domain) {
            $result = $this->checkDomain($domain);
            $results[$domain] = $result;
            
            if ($result['healthy']) {
                $healthyCount++;
            }
            
            $status = $result['healthy'] ? 'HEALTHY' : 'UNHEALTHY';
            $this->log("Domain {$domain}: {$status} (Response time: {$result['response_time']}ms)");
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
        $this->checkAlertConditions($results, $healthyCount);
        
        return $results;
    }
    
    private function checkDomain($domain) {
        $start = microtime(true);
        $healthEndpoint = "https://{$domain}/api/health";
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $healthEndpoint,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_CONNECTTIMEOUT => 5,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => false,
            CURLOPT_USERAGENT => 'Domain-Monitor/1.0',
            CURLOPT_HTTPHEADER => [
                'Accept: application/json',
                'Cache-Control: no-cache'
            ]
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $curlError = curl_error($ch);
        $connectTime = curl_getinfo($ch, CURLINFO_CONNECT_TIME) * 1000;
        $totalTime = curl_getinfo($ch, CURLINFO_TOTAL_TIME) * 1000;
        curl_close($ch);
        
        $responseTime = round((microtime(true) - $start) * 1000, 2);
        
        // è§£æå“åº”
        $healthData = null;
        if ($response) {
            $healthData = json_decode($response, true);
        }
        
        $isHealthy = ($httpCode === 200 && !$curlError && $healthData && $healthData['status'] === 'healthy');
        
        return [
            'healthy' => $isHealthy,
            'http_code' => $httpCode,
            'response_time' => $responseTime,
            'connect_time' => round($connectTime, 2),
            'total_time' => round($totalTime, 2),
            'error' => $curlError,
            'response_data' => $healthData,
            'timestamp' => time()
        ];
    }
    
    private function checkAlertConditions($results, $healthyCount) {
        $totalDomains = count($this->domains);
        $unhealthyCount = $totalDomains - $healthyCount;
        
        // å¦‚æœè¶…è¿‡ä¸€åŠåŸŸåä¸å¯ç”¨ï¼Œå‘é€å‘Šè­¦
        if ($unhealthyCount > $totalDomains / 2) {
            $this->sendAlert("CRITICAL: {$unhealthyCount}/{$totalDomains} domains are unhealthy!", $results);
        }
        // å¦‚æœåªæœ‰ä¸€ä¸ªåŸŸåå¯ç”¨ï¼Œå‘é€è­¦å‘Š
        elseif ($healthyCount === 1) {
            $this->sendAlert("WARNING: Only 1 domain is healthy!", $results);
        }
    }
    
    private function sendAlert($message, $results) {
        $alertData = [
            'message' => $message,
            'timestamp' => date('Y-m-d H:i:s'),
            'results' => $results
        ];
        
        // è®°å½•åˆ°æ—¥å¿—
        $this->log("ALERT: " . $message);
        
        // å‘é€åˆ°webhook (å¦‚æœé…ç½®äº†)
        if ($this->alertWebhook) {
            $this->sendWebhook($alertData);
        }
        
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–å‘Šè­¦æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€çŸ­ä¿¡ç­‰
    }
    
    private function sendWebhook($data) {
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $this->alertWebhook,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => json_encode($data),
            CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
            CURLOPT_TIMEOUT => 10
        ]);
        
        curl_exec($ch);
        curl_close($ch);
    }
    
    private function log($message) {
        $timestamp = date('Y-m-d H:i:s');
        $logEntry = "[{$timestamp}] {$message}\n";
        file_put_contents($this->logFile, $logEntry, FILE_APPEND | LOCK_EX);
    }
    
    public function generateReport() {
        $results = $this->checkAllDomains();
        
        // ç”Ÿæˆç®€å•çš„çŠ¶æ€æŠ¥å‘Š
        $report = [
            'timestamp' => date('Y-m-d H:i:s'),
            'summary' => [
                'total_domains' => count($this->domains),
                'healthy_domains' => array_sum(array_column($results, 'healthy')),
                'average_response_time' => round(array_sum(array_column($results, 'response_time')) / count($results), 2)
            ],
            'details' => $results
        ];
        
        return $report;
    }
}

// å‘½ä»¤è¡Œè¿è¡Œ
if (php_sapi_name() === 'cli') {
    $monitor = new DomainMonitor();
    $report = $monitor->generateReport();
    
    echo json_encode($report, JSON_PRETTY_PRINT) . "\n";
    
    // å¦‚æœæœ‰å‚æ•° --alertï¼Œæ£€æŸ¥å‘Šè­¦æ¡ä»¶
    if (in_array('--alert', $argv)) {
        $healthyCount = $report['summary']['healthy_domains'];
        $totalCount = $report['summary']['total_domains'];
        
        if ($healthyCount < $totalCount) {
            echo "WARNING: {$healthyCount}/{$totalCount} domains are healthy\n";
            exit(1);
        } else {
            echo "OK: All domains are healthy\n";
            exit(0);
        }
    }
}
```

#### 4.2 æ—¥å¿—åˆ†æè„šæœ¬

**æ–‡ä»¶è·¯å¾„**: `scripts/analyze-logs.sh`

```bash
#!/bin/bash

# é…ç½®
NGINX_LOG="/var/log/nginx/domain_access.log"
DOMAIN_LOG="/var/www/html/scripts/logs/domain_monitor.log" 
SWITCH_LOG="/var/www/html/runtime/log/domain_switches.log"
REPORT_DIR="/var/www/html/scripts/reports"
DATE=$(date +%Y-%m-%d)

# åˆ›å»ºæŠ¥å‘Šç›®å½•
mkdir -p $REPORT_DIR

echo "=== åŸŸåè®¿é—®åˆ†ææŠ¥å‘Š ($DATE) ===" > $REPORT_DIR/daily_report_$DATE.txt

# 1. åŸŸåè®¿é—®ç»Ÿè®¡
echo "" >> $REPORT_DIR/daily_report_$DATE.txt
echo "### åŸŸåè®¿é—®åˆ†å¸ƒ" >> $REPORT_DIR/daily_report_$DATE.txt
if [ -f "$NGINX_LOG" ]; then
    awk -v date="$DATE" '$4 ~ date {match($0, /domain="([^"]*)"/, arr); print arr[1]}' $NGINX_LOG | \
    sort | uniq -c | sort -nr >> $REPORT_DIR/daily_report_$DATE.txt
else
    echo "Nginxæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨" >> $REPORT_DIR/daily_report_$DATE.txt
fi

# 2. å“åº”æ—¶é—´ç»Ÿè®¡
echo "" >> $REPORT_DIR/daily_report_$DATE.txt
echo "### å¹³å‡å“åº”æ—¶é—´ (æŒ‰åŸŸå)" >> $REPORT_DIR/daily_report_$DATE.txt
if [ -f "$NGINX_LOG" ]; then
    awk -v date="$DATE" '$4 ~ date {
        match($0, /domain="([^"]*)"/, domain_arr);
        match($0, /response_time=([0-9.]+)/, time_arr);
        if(domain_arr[1] && time_arr[1]) {
            domains[domain_arr[1]] += time_arr[1];
            counts[domain_arr[1]]++;
        }
    } END {
        for(domain in domains) {
            avg = domains[domain] / counts[domain];
            printf "%s: %.3fç§’ (è¯·æ±‚æ•°: %d)\n", domain, avg, counts[domain];
        }
    }' $NGINX_LOG >> $REPORT_DIR/daily_report_$DATE.txt
fi

# 3. é”™è¯¯çŠ¶æ€ç ç»Ÿè®¡
echo "" >> $REPORT_DIR/daily_report_$DATE.txt
echo "### é”™è¯¯çŠ¶æ€ç ç»Ÿè®¡" >> $REPORT_DIR/daily_report_$DATE.txt
if [ -f "$NGINX_LOG" ]; then
    awk -v date="$DATE" '$4 ~ date && $9 >= 400 {
        match($0, /domain="([^"]*)"/, domain_arr);
        errors[domain_arr[1]"-"$9]++;
    } END {
        for(error in errors) {
            print error": "errors[error];
        }
    }' $NGINX_LOG | sort >> $REPORT_DIR/daily_report_$DATE.txt
fi

# 4. åŸŸååˆ‡æ¢ç»Ÿè®¡
echo "" >> $REPORT_DIR/daily_report_$DATE.txt
echo "### åŸŸååˆ‡æ¢è®°å½•" >> $REPORT_DIR/daily_report_$DATE.txt
if [ -f "$SWITCH_LOG" ]; then
    grep "$DATE" $SWITCH_LOG | wc -l | xargs echo "ä»Šæ—¥åˆ‡æ¢æ¬¡æ•°: " >> $REPORT_DIR/daily_report_$DATE.txt
    echo "åˆ‡æ¢è¯¦æƒ…:" >> $REPORT_DIR/daily_report_$DATE.txt
    grep "$DATE" $SWITCH_LOG | tail -10 >> $REPORT_DIR/daily_report_$DATE.txt
else
    echo "æ— åŸŸååˆ‡æ¢è®°å½•" >> $REPORT_DIR/daily_report_$DATE.txt
fi

# 5. åŸŸåå¥åº·çŠ¶æ€
echo "" >> $REPORT_DIR/daily_report_$DATE.txt
echo "### å½“å‰åŸŸåå¥åº·çŠ¶æ€" >> $REPORT_DIR/daily_report_$DATE.txt
/usr/bin/php /var/www/html/scripts/domain-monitor.php --alert >> $REPORT_DIR/daily_report_$DATE.txt

# è¾“å‡ºæŠ¥å‘Š
cat $REPORT_DIR/daily_report_$DATE.txt

# æ¸…ç†æ—§æŠ¥å‘Š (ä¿ç•™30å¤©)
find $REPORT_DIR -name "daily_report_*.txt" -mtime +30 -delete

echo ""
echo "æŠ¥å‘Šå·²ä¿å­˜åˆ°: $REPORT_DIR/daily_report_$DATE.txt"
```

---

## éƒ¨ç½²å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºJavaScriptåŸŸååˆ‡æ¢å™¨

ç°åœ¨è®©æˆ‘å¼€å§‹ä¸ºæ‚¨åˆ›å»ºå…·ä½“çš„å®æ–½æ–‡ä»¶ï¼š

### 1. åˆ›å»ºå®¢æˆ·ç«¯JavaScriptæ–‡ä»¶

```bash
# å°†å®¢æˆ·ç«¯JavaScriptæ™ºèƒ½æ•…éšœè½¬ç§»ä»£ç å¤åˆ¶åˆ°æœåŠ¡å™¨
scp /path/to/domain-switcher.js /var/www/html/public/static/js/

# é…ç½®å‰ç«¯ä»£ç 
sudo sed -i '/window.domainSwitcher = new DomainSwitcher();/a // é¡µé¢åŠ è½½å®Œæˆåé¢å¤–æ£€æŸ¥ document.addEventListener(\'DOMContentLoaded\', function() { // æ¢å¤é¡µé¢çŠ¶æ€ const savedState = localStorage.getItem(\'pageState\'); if (savedState) { try { const state = JSON.parse(savedState); // å¦‚æœæ˜¯æœ€è¿‘çš„åˆ‡æ¢(5åˆ†é’Ÿå†…)ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›æ¢å¤æ“ä½œ if (Date.now() - state.timestamp < 300000) { console.log(\'Restored from domain switch:\', state); } localStorage.removeItem(\'pageState\'); } catch (error) { console.log(\'Failed to restore state:\', error); } } });' /var/www/html/public/static/js/domain-switcher.js

# é‡å¯Nginx
sudo systemctl restart nginx
```

#### 3.2 é¡µé¢é›†æˆ
```bash
# åœ¨ä¸»æ¨¡æ¿ä¸­æ·»åŠ 
<script src="/static/js/domain-switcher.js" defer></script>

# å¯é€‰ï¼šæ˜¾ç¤ºå½“å‰åŸŸåçŠ¶æ€
<div id="domain-status" style="position: fixed; top: 10px; right: 10px; z-index: 9999; 
     background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px;">
    å½“å‰åŸŸåæ­£å¸¸
</div>

<script>
// æ˜¾ç¤ºåŸŸåçŠ¶æ€
function updateDomainStatus() {
    const statusEl = document.getElementById('domain-status');
    if (statusEl && window.domainSwitcher) {
        const currentDomain = window.location.hostname;
        window.domainSwitcher.checkDomainHealth(currentDomain).then(isHealthy => {
            statusEl.textContent = isHealthy ? 'åŸŸåæ­£å¸¸' : 'æ£€æµ‹åˆ‡æ¢ä¸­...';
            statusEl.style.backgroundColor = isHealthy ? '#28a745' : '#dc3545';
        });
    }
}

// æ¯30ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€æ˜¾ç¤º
setInterval(updateDomainStatus, 30000);
updateDomainStatus();
</script>
```

### é˜¶æ®µ4: ç›‘æ§å’Œæ—¥å¿—åˆ†æ (1å¤©)

#### 4.1 éƒ¨ç½²åŸŸåç›‘æ§è„šæœ¬
```bash
# å°†åŸŸåç›‘æ§è„šæœ¬å¤åˆ¶åˆ°æœåŠ¡å™¨
scp /path/to/domain-monitor.php /var/www/html/scripts/

# é…ç½®åŸŸåç›‘æ§è„šæœ¬
sudo sed -i '/$domains = \[/a $domains = \['main.yourdomain.com', 'backup1.yourdomain.com', 'backup2.yourdomain.com', 'backup3.yourdomain.com'\];' /var/www/html/scripts/domain-monitor.php

# é‡å¯Nginx
sudo systemctl restart nginx
```

#### 4.2 éƒ¨ç½²æ—¥å¿—åˆ†æè„šæœ¬
```bash
# å°†æ—¥å¿—åˆ†æè„šæœ¬å¤åˆ¶åˆ°æœåŠ¡å™¨
scp /path/to/analyze-logs.sh /var/www/html/scripts/

# é…ç½®æ—¥å¿—åˆ†æè„šæœ¬
sudo sed -i '/$domains = \[/a $domains = \['main.yourdomain.com', 'backup1.yourdomain.com', 'backup2.yourdomain.com', 'backup3.yourdomain.com'\];' /var/www/html/scripts/analyze-logs.sh

# é‡å¯Nginx
sudo systemctl restart nginx
```
