# å¤šåŸŸååŠ¨æ€åˆ‡æ¢å®Œæ•´é›†æˆæ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜åˆ†æ

### å½“å‰é…ç½®å±€é™æ€§
- âŒ `9.CFé…ç½®.md` ä»…æ”¯æŒ**å•ä¸ªä¸»åŸŸåçš„å­åŸŸå**åˆ‡æ¢
- âŒ æ— æ³•å¤„ç†**å®Œå…¨ä¸åŒçš„å¤šä¸ªåŸŸå**
- âŒ å®¢æˆ·ç«¯JSä¸Cloudflareé…ç½®æœªå®Œå…¨æ•´åˆ

### å®é™…éœ€æ±‚
- âœ… æ”¯æŒ**å¤šä¸ªå®Œå…¨ä¸åŒçš„åŸŸå**ï¼ˆå¦‚ domain1.com, domain2.net, domain3.orgï¼‰
- âœ… å½“æŸä¸ªåŸŸåè¢«å°é”æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–åŸŸå
- âœ… ä¸‰å±‚åˆ‡æ¢æ¶æ„ï¼š**å®¢æˆ·ç«¯JS + Cloudflare DNS + æœåŠ¡ç«¯ç›‘æ§**

---

## ğŸ—ï¸ å®Œæ•´å¤šåŸŸåæ¶æ„è®¾è®¡

### æ¶æ„å›¾
```
ç”¨æˆ·è¯·æ±‚ â†’ å®¢æˆ·ç«¯æ™ºèƒ½åˆ‡æ¢ â†’ å¤šåŸŸåDNSæ±  â†’ æœåŠ¡ç«¯ç»Ÿä¸€å¤„ç†
    â†“           â†“               â†“            â†“
å¤šåŸŸåæ±      å®æ—¶å¥åº·æ£€æŸ¥     Cloudflareç®¡ç†    ç»Ÿä¸€åç«¯
```

### ä¸‰å±‚é˜²æŠ¤å‡çº§ç‰ˆ

#### ç¬¬ä¸€å±‚ï¼šå®¢æˆ·ç«¯å¤šåŸŸåæ™ºèƒ½åˆ‡æ¢
- æ”¯æŒ**å®Œå…¨ä¸åŒçš„å¤šä¸ªåŸŸå**
- è·¨åŸŸå¥åº·æ£€æŸ¥
- æœ¬åœ°åŸŸåæ± ç®¡ç†

#### ç¬¬äºŒå±‚ï¼šCloudflareå¤šåŸŸåDNSç®¡ç†
- **æ¯ä¸ªåŸŸåç‹¬ç«‹é…ç½®**
- è·¨åŸŸåæ•…éšœè½¬ç§»
- ç»Ÿä¸€å¥åº·æ£€æŸ¥

#### ç¬¬ä¸‰å±‚ï¼šæœåŠ¡ç«¯ç»Ÿä¸€å¤„ç†
- æ”¯æŒæ‰€æœ‰åŸŸåè®¿é—®
- ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥API
- è·¨åŸŸåæ—¥å¿—è®°å½•

---

## ğŸ“‹ å¤šåŸŸåé…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¤šä¸ªç‹¬ç«‹åŸŸåï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ‚¨æœ‰å¤šä¸ªå®Œå…¨ä¸åŒçš„åŸŸå
- `domain1.com`
- `domain2.net` 
- `domain3.org`
- `domain4.cc`

#### Cloudflareé…ç½®ç­–ç•¥

**ä¸ºæ¯ä¸ªåŸŸååˆ†åˆ«é…ç½®ï¼š**

1. **æ¯ä¸ªåŸŸåéƒ½éœ€è¦æ·»åŠ åˆ°Cloudflare**
2. **æ¯ä¸ªåŸŸåéƒ½é…ç½®ç›¸åŒçš„å¥åº·æ£€æŸ¥**
3. **æ‰€æœ‰åŸŸåæŒ‡å‘åŒä¸€æœåŠ¡å™¨IP**
4. **å®¢æˆ·ç«¯JSç®¡ç†æ‰€æœ‰åŸŸåæ± **

#### å…·ä½“é…ç½®æ­¥éª¤

##### 1. æ‰¹é‡æ·»åŠ åŸŸååˆ°Cloudflare

ä¸ºæ¯ä¸ªåŸŸåé‡å¤ä»¥ä¸‹æ­¥éª¤ï¼š

```
åŸŸå1: domain1.com
â”œâ”€â”€ DNS Records:
â”‚   â”œâ”€â”€ A    @           YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â”œâ”€â”€ A    www         YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â””â”€â”€ TTL: 60ç§’
â”œâ”€â”€ Health Check: https://domain1.com/api/health
â”œâ”€â”€ Pool: domain1-pool
â””â”€â”€ Load Balancer: domain1-lb

åŸŸå2: domain2.net
â”œâ”€â”€ DNS Records:
â”‚   â”œâ”€â”€ A    @           YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â”œâ”€â”€ A    www         YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â””â”€â”€ TTL: 60ç§’
â”œâ”€â”€ Health Check: https://domain2.net/api/health
â”œâ”€â”€ Pool: domain2-pool
â””â”€â”€ Load Balancer: domain2-lb

åŸŸå3: domain3.org
â”œâ”€â”€ DNS Records:
â”‚   â”œâ”€â”€ A    @           YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â”œâ”€â”€ A    www         YOUR_SERVER_IP    ğŸ§¡ ä»£ç†
â”‚   â””â”€â”€ TTL: 60ç§’
â”œâ”€â”€ Health Check: https://domain3.org/api/health
â”œâ”€â”€ Pool: domain3-pool
â””â”€â”€ Load Balancer: domain3-lb
```

##### 2. ç»Ÿä¸€å¥åº·æ£€æŸ¥é…ç½®

ä¸ºæ¯ä¸ªåŸŸååˆ›å»ºç‹¬ç«‹çš„å¥åº·æ£€æŸ¥ï¼š

```yaml
å¥åº·æ£€æŸ¥é…ç½®æ¨¡æ¿:
åç§°: health-check-{domain}
URL: https://{domain}/api/health
æ–¹æ³•: GET
ç«¯å£: 443
è¶…æ—¶: 5ç§’
é—´éš”: 60ç§’
é‡è¯•: 2æ¬¡
æœŸæœ›: 200çŠ¶æ€ç 
åŒºåŸŸ: å¤šä¸ªåŒºåŸŸ(3-5ä¸ª)

å®ä¾‹:
health-check-domain1: https://domain1.com/api/health
health-check-domain2: https://domain2.net/api/health
health-check-domain3: https://domain3.org/api/health
```

##### 3. æ± é…ç½®ç­–ç•¥

**é€‰é¡¹1ï¼šæ¯åŸŸåå•ç‹¬æ± ï¼ˆç®€å•ï¼‰**
```yaml
domain1-pool:
  endpoints: [YOUR_SERVER_IP:443]
  health_check: health-check-domain1
  host_header: domain1.com

domain2-pool:
  endpoints: [YOUR_SERVER_IP:443]
  health_check: health-check-domain2
  host_header: domain2.net

domain3-pool:
  endpoints: [YOUR_SERVER_IP:443]
  health_check: health-check-domain3
  host_header: domain3.org
```

**é€‰é¡¹2ï¼šå…±äº«æ± +ç‹¬ç«‹å¥åº·æ£€æŸ¥ï¼ˆé«˜çº§ï¼‰**
```yaml
shared-primary-pool:
  endpoints: [YOUR_SERVER_IP:443]
  health_checks: [
    health-check-domain1,
    health-check-domain2,
    health-check-domain3
  ]
  å¥åº·é˜ˆå€¼: 1 (ä»»ä¸€å¥åº·æ£€æŸ¥é€šè¿‡å³è®¤ä¸ºæ± å¥åº·)
```

##### 4. è´Ÿè½½å‡è¡¡å™¨é…ç½®

ä¸ºæ¯ä¸ªåŸŸååˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ï¼š

```yaml
domain1-lb:
  hostname: @ (æ ¹åŸŸå)
  pools: [domain1-pool]
  fallback: shared-backup-pool (å¯é€‰)

domain2-lb:
  hostname: @ (æ ¹åŸŸå)
  pools: [domain2-pool]
  fallback: shared-backup-pool (å¯é€‰)

domain3-lb:
  hostname: @ (æ ¹åŸŸå)
  pools: [domain3-pool]
  fallback: shared-backup-pool (å¯é€‰)
```

### æ–¹æ¡ˆBï¼šæ··åˆåŸŸå+å­åŸŸå

**é€‚ç”¨åœºæ™¯ï¼š** ä¸»åŸŸå+å­åŸŸå+ç‹¬ç«‹åŸŸåæ··åˆ

```
ä¸»åŸŸåä½“ç³»: yourdomain.com
â”œâ”€â”€ main.yourdomain.com
â”œâ”€â”€ backup1.yourdomain.com
â””â”€â”€ backup2.yourdomain.com

ç‹¬ç«‹åŸŸå:
â”œâ”€â”€ alternative1.net
â”œâ”€â”€ alternative2.org
â””â”€â”€ fallback.cc
```

---

## ğŸ’» å®¢æˆ·ç«¯JSå‡çº§ç‰ˆ

### å¤šåŸŸåæ™ºèƒ½åˆ‡æ¢å™¨

æ›´æ–° `public/static/js/domain-switcher.js`ï¼š

```javascript
class MultiDomainSwitcher {
    constructor() {
        // æ”¯æŒå®Œå…¨ä¸åŒçš„å¤šä¸ªåŸŸå
        this.domainPools = {
            // ä¸»åŸŸåæ± 
            primary: [
                'domain1.com',
                'www.domain1.com'
            ],
            // å¤‡ç”¨åŸŸåæ± 
            backup: [
                'domain2.net',
                'www.domain2.net',
                'domain3.org',
                'www.domain3.org'
            ],
            // ç´§æ€¥åŸŸåæ± 
            emergency: [
                'domain4.cc',
                'fallback.info'
            ]
        };
        
        // å±•å¹³æ‰€æœ‰åŸŸåä¸ºå•ä¸€æ•°ç»„
        this.allDomains = [
            ...this.domainPools.primary,
            ...this.domainPools.backup,
            ...this.domainPools.emergency
        ];
        
        this.currentDomain = window.location.hostname;
        this.healthCheckTimeout = 8000; // 8ç§’è¶…æ—¶(è·¨åŸŸéœ€è¦æ›´é•¿æ—¶é—´)
        this.retryInterval = 45000;     // 45ç§’æ£€æŸ¥é—´éš”
        this.maxRetries = 3;
        
        this.init();
    }
    
    init() {
        this.loadDomainPreferences();
        this.startCrossDomainHealthCheck();
        this.interceptFailures();
        this.setupVisibilityHandler();
    }
    
    // è·¨åŸŸå¥åº·æ£€æŸ¥
    async checkDomainHealth(domain) {
        // æ–¹æ³•1: ä½¿ç”¨fetchè¿›è¡Œå¥åº·æ£€æŸ¥
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout);
            
            const response = await fetch(`https://${domain}/api/health`, {
                method: 'GET',
                mode: 'cors',
                credentials: 'omit',
                cache: 'no-cache',
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'MultiDomain-Switcher/1.0'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const data = await response.json();
                return data.status === 'healthy';
            }
            return false;
        } catch (error) {
            // æ–¹æ³•2: å¦‚æœCORSå¤±è´¥ï¼Œä½¿ç”¨å›¾ç‰‡æ¢æµ‹
            return await this.fallbackImageProbe(domain);
        }
    }
    
    // å¤‡ç”¨æ¢æµ‹æ–¹æ³•ï¼šå›¾ç‰‡æ¢æµ‹
    async fallbackImageProbe(domain) {
        return new Promise((resolve) => {
            const img = new Image();
            const timeout = setTimeout(() => {
                resolve(false);
            }, this.healthCheckTimeout);
            
            img.onload = () => {
                clearTimeout(timeout);
                resolve(true);
            };
            
            img.onerror = () => {
                clearTimeout(timeout);
                resolve(false);
            };
            
            // ä½¿ç”¨ä¸€ä¸ªå°çš„1x1åƒç´ å›¾ç‰‡è¿›è¡Œæ¢æµ‹
            img.src = `https://${domain}/api/health?probe=image&t=${Date.now()}`;
        });
    }
    
    // æ™ºèƒ½åŸŸåé€‰æ‹©
    async findBestDomain() {
        // 1. ä¼˜å…ˆæ£€æŸ¥å½“å‰åŸŸå
        if (await this.checkDomainHealth(this.currentDomain)) {
            return this.currentDomain;
        }
        
        // 2. æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥åŸŸåæ± 
        const poolOrder = ['primary', 'backup', 'emergency'];
        
        for (const poolName of poolOrder) {
            const pool = this.domainPools[poolName];
            
            for (const domain of pool) {
                if (domain === this.currentDomain) continue;
                
                if (await this.checkDomainHealth(domain)) {
                    console.log(`Found healthy domain: ${domain} (pool: ${poolName})`);
                    this.saveDomainPreference(domain, poolName);
                    return domain;
                }
            }
        }
        
        return null;
    }
    
    // æ‰§è¡ŒåŸŸååˆ‡æ¢
    async switchToBestDomain() {
        const bestDomain = await this.findBestDomain();
        
        if (bestDomain && bestDomain !== this.currentDomain) {
            this.logDomainSwitch(this.currentDomain, bestDomain);
            this.preserveUserState();
            
            // æ„å»ºæ–°URL
            const newUrl = `https://${bestDomain}${window.location.pathname}${window.location.search}${window.location.hash}`;
            
            console.log(`Switching from ${this.currentDomain} to ${bestDomain}`);
            this.showSwitchNotification(bestDomain);
            
            // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€šçŸ¥
            setTimeout(() => {
                window.location.href = newUrl;
            }, 1000);
            
            return true;
        }
        
        return false;
    }
    
    // æ˜¾ç¤ºåˆ‡æ¢é€šçŸ¥
    showSwitchNotification(newDomain) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b35;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            ğŸ”„ åŸŸååˆ‡æ¢ä¸­...
            <br>å³å°†è·³è½¬åˆ°: <strong>${newDomain}</strong>
        `;
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(notification);
    }
    
    // ä¿å­˜ç”¨æˆ·çŠ¶æ€
    preserveUserState() {
        const state = {
            url: window.location.href,
            timestamp: Date.now(),
            referrer: document.referrer,
            scrollX: window.scrollX,
            scrollY: window.scrollY,
            userAgent: navigator.userAgent
        };
        
        localStorage.setItem('domainSwitchState', JSON.stringify(state));
    }
    
    // ä¿å­˜åŸŸååå¥½
    saveDomainPreference(domain, pool) {
        const preference = {
            domain: domain,
            pool: pool,
            timestamp: Date.now(),
            successCount: this.getDomainSuccessCount(domain) + 1
        };
        
        localStorage.setItem('preferredDomain', JSON.stringify(preference));
    }
    
    // åŠ è½½åŸŸååå¥½
    loadDomainPreferences() {
        try {
            const saved = localStorage.getItem('preferredDomain');
            if (saved) {
                const preference = JSON.parse(saved);
                // å¦‚æœä¿å­˜çš„åŸŸååå¥½åœ¨24å°æ—¶å†…ï¼Œä¸”åœ¨åŸŸååˆ—è¡¨ä¸­
                if (Date.now() - preference.timestamp < 86400000 && 
                    this.allDomains.includes(preference.domain)) {
                    // å°†åå¥½åŸŸåç§»åˆ°å¯¹åº”æ± çš„å‰é¢
                    this.promoteDomainInPool(preference.domain, preference.pool);
                }
            }
        } catch (error) {
            console.log('Failed to load domain preferences:', error);
        }
    }
    
    // æå‡åŸŸååœ¨æ± ä¸­çš„ä¼˜å…ˆçº§
    promoteDomainInPool(domain, poolName) {
        const pool = this.domainPools[poolName];
        if (pool && pool.includes(domain)) {
            // ç§»åˆ°æ± çš„ç¬¬ä¸€ä½
            const index = pool.indexOf(domain);
            if (index > 0) {
                pool.splice(index, 1);
                pool.unshift(domain);
            }
        }
    }
    
    // è·å–åŸŸåæˆåŠŸæ¬¡æ•°
    getDomainSuccessCount(domain) {
        try {
            const stats = JSON.parse(localStorage.getItem('domainStats') || '{}');
            return stats[domain]?.successCount || 0;
        } catch {
            return 0;
        }
    }
    
    // å¼€å§‹è·¨åŸŸå¥åº·æ£€æŸ¥
    startCrossDomainHealthCheck() {
        // é¡µé¢å¯è§æ—¶æ›´é¢‘ç¹æ£€æŸ¥
        setInterval(async () => {
            if (!document.hidden) {
                const isCurrentHealthy = await this.checkDomainHealth(this.currentDomain);
                
                if (!isCurrentHealthy) {
                    console.log('Current domain unhealthy, attempting switch...');
                    await this.switchToBestDomain();
                }
            }
        }, this.retryInterval);
    }
    
    // é¡µé¢å¯è§æ€§å¤„ç†
    setupVisibilityHandler() {
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œç«‹å³æ£€æŸ¥åŸŸåå¥åº·çŠ¶æ€
                setTimeout(async () => {
                    const isHealthy = await this.checkDomainHealth(this.currentDomain);
                    if (!isHealthy) {
                        await this.switchToBestDomain();
                    }
                }, 1000);
            }
        });
    }
    
    // æ‹¦æˆªç½‘ç»œå¤±è´¥
    interceptFailures() {
        const originalFetch = window.fetch;
        const self = this;
        
        window.fetch = async function(...args) {
            let retryCount = 0;
            
            while (retryCount < self.maxRetries) {
                try {
                    const response = await originalFetch.apply(this, args);
                    
                    // å¦‚æœå“åº”æˆåŠŸï¼Œè¿”å›ç»“æœ
                    if (response.ok) {
                        return response;
                    }
                    
                    // å¦‚æœæ˜¯æœåŠ¡å™¨é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼Œå°è¯•åŸŸååˆ‡æ¢
                    if (response.status >= 500 || response.status === 0) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return response;
                } catch (error) {
                    retryCount++;
                    console.log(`Fetch attempt ${retryCount} failed:`, error.message);
                    
                    if (retryCount >= self.maxRetries) {
                        // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢åŸŸå
                        const switched = await self.switchToBestDomain();
                        if (switched) {
                            // åŸŸååˆ‡æ¢ä¸­ï¼Œé¡µé¢å°†é‡å®šå‘
                            return Promise.reject(new Error('Domain switching'));
                        }
                        throw error;
                    }
                    
                    // ç­‰å¾…åé‡è¯•
                    await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                }
            }
        };
    }
    
    // è®°å½•åŸŸååˆ‡æ¢æ—¥å¿—
    logDomainSwitch(fromDomain, toDomain) {
        const logData = {
            timestamp: new Date().toISOString(),
            from: fromDomain,
            to: toDomain,
            userAgent: navigator.userAgent,
            url: window.location.href,
            referrer: document.referrer
        };
        
        // å‘é€åˆ°æœåŠ¡å™¨
        this.sendSwitchLog(logData);
        
        // æœ¬åœ°å­˜å‚¨
        this.storeLocalLog(logData);
    }
    
    async sendSwitchLog(logData) {
        try {
            await fetch('/api/log-domain-switch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(logData)
            });
        } catch (error) {
            console.log('Failed to send switch log:', error);
        }
    }
    
    storeLocalLog(logData) {
        try {
            const logs = JSON.parse(localStorage.getItem('domainSwitchLogs') || '[]');
            logs.push(logData);
            
            // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
            if (logs.length > 100) {
                logs.splice(0, logs.length - 100);
            }
            
            localStorage.setItem('domainSwitchLogs', JSON.stringify(logs));
        } catch (error) {
            console.log('Failed to store local log:', error);
        }
    }
}

// å…¨å±€åˆå§‹åŒ–
window.multiDomainSwitcher = new MultiDomainSwitcher();

// é¡µé¢åŠ è½½å®ŒæˆåçŠ¶æ€æ¢å¤
document.addEventListener('DOMContentLoaded', function() {
    try {
        const savedState = localStorage.getItem('domainSwitchState');
        if (savedState) {
            const state = JSON.parse(savedState);
            
            // å¦‚æœæ˜¯æœ€è¿‘çš„åˆ‡æ¢(10åˆ†é’Ÿå†…)
            if (Date.now() - state.timestamp < 600000) {
                console.log('Restored from domain switch:', state);
                
                // æ¢å¤æ»šåŠ¨ä½ç½®
                if (state.scrollX || state.scrollY) {
                    setTimeout(() => {
                        window.scrollTo(state.scrollX, state.scrollY);
                    }, 100);
                }
            }
            
            localStorage.removeItem('domainSwitchState');
        }
    } catch (error) {
        console.log('Failed to restore state:', error);
    }
});
```

---

## ğŸ–¥ï¸ æœåŠ¡ç«¯é…ç½®å‡çº§

### PHPå¥åº·æ£€æŸ¥APIå¢å¼º

æ›´æ–° `application/index/controller/Health.php`ï¼š

```php
<?php
namespace app\index\controller;

use think\Controller;
use think\Response;

class Health extends Controller
{
    /**
     * å¤šåŸŸåå¥åº·æ£€æŸ¥æ¥å£
     */
    public function index()
    {
        $startTime = microtime(true);
        $currentDomain = $_SERVER['HTTP_HOST'] ?? '';
        
        // å¤„ç†å›¾ç‰‡æ¢æµ‹è¯·æ±‚
        if ($this->request->param('probe') === 'image') {
            return $this->handleImageProbe();
        }
        
        $healthStatus = $this->performHealthChecks();
        $responseTime = round((microtime(true) - $startTime) * 1000, 2);
        
        $responseData = [
            'status' => $healthStatus['healthy'] ? 'healthy' : 'unhealthy',
            'timestamp' => time(),
            'domain' => $currentDomain,
            'server' => [
                'hostname' => gethostname(),
                'ip' => $_SERVER['SERVER_ADDR'] ?? '',
                'load' => $this->getServerLoad()
            ],
            'response_time_ms' => $responseTime,
            'checks' => $healthStatus['checks'],
            'version' => '2.0.0'
        ];
        
        $httpStatus = $healthStatus['healthy'] ? 200 : 503;
        
        return Response::create($responseData, 'json', $httpStatus)
            ->header($this->getCorsHeaders());
    }
    
    /**
     * å¤„ç†å›¾ç‰‡æ¢æµ‹è¯·æ±‚
     */
    private function handleImageProbe()
    {
        // åˆ›å»º1x1é€æ˜åƒç´ å›¾
        $imageData = base64_decode('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==');
        
        return Response::create($imageData, 'json', 200)
            ->header(array_merge($this->getCorsHeaders(), [
                'Content-Type' => 'image/png',
                'Content-Length' => strlen($imageData)
            ]));
    }
    
    /**
     * è·å–CORSå¤´
     */
    private function getCorsHeaders()
    {
        return [
            'Access-Control-Allow-Origin' => '*',
            'Access-Control-Allow-Methods' => 'GET, POST, OPTIONS',
            'Access-Control-Allow-Headers' => 'Content-Type, Authorization, User-Agent',
            'Access-Control-Max-Age' => '86400',
            'Cache-Control' => 'no-cache, no-store, must-revalidate',
            'Pragma' => 'no-cache',
            'Expires' => '0'
        ];
    }
    
    /**
     * åŸŸååˆ‡æ¢ç»Ÿè®¡æ¥å£
     */
    public function switchStats()
    {
        $logFile = ROOT_PATH . 'runtime/log/domain_switches.log';
        $stats = $this->analyzeSwitchLogs($logFile);
        
        return Response::create([
            'status' => 'success',
            'data' => $stats
        ], 'json', 200)->header($this->getCorsHeaders());
    }
    
    /**
     * åŸŸååˆ—è¡¨æ¥å£
     */
    public function domainList()
    {
        $domains = $this->getConfiguredDomains();
        
        return Response::create([
            'status' => 'success',
            'domains' => $domains,
            'current' => $_SERVER['HTTP_HOST'] ?? ''
        ], 'json', 200)->header($this->getCorsHeaders());
    }
    
    private function getConfiguredDomains()
    {
        // ä»é…ç½®æ–‡ä»¶è¯»å–åŸŸååˆ—è¡¨
        $configFile = ROOT_PATH . 'config/domains.php';
        if (file_exists($configFile)) {
            return include $configFile;
        }
        
        // é»˜è®¤åŸŸååˆ—è¡¨
        return [
            'primary' => ['domain1.com', 'www.domain1.com'],
            'backup' => ['domain2.net', 'domain3.org'],
            'emergency' => ['domain4.cc']
        ];
    }
    
    private function getServerLoad()
    {
        if (function_exists('sys_getloadavg')) {
            $load = sys_getloadavg();
            return [
                '1min' => $load[0],
                '5min' => $load[1],
                '15min' => $load[2]
            ];
        }
        return null;
    }
    
    // ... å…¶ä»–ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜
}
```

### Nginxå¤šåŸŸåé…ç½®

æ›´æ–° `nginx/conf.d/multidomain.conf`ï¼š

```nginx
# å¤šåŸŸåæ˜ å°„
map $host $domain_backend {
    default                 backend_servers;
    ~^domain1\.com$        backend_servers;
    ~^www\.domain1\.com$   backend_servers;
    ~^domain2\.net$        backend_servers;
    ~^www\.domain2\.net$   backend_servers;
    ~^domain3\.org$        backend_servers;
    ~^www\.domain3\.org$   backend_servers;
    ~^domain4\.cc$         backend_servers;
}

# å¤šåŸŸåæ—¥å¿—æ ¼å¼
log_format multidomain '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'domain="$host" backend="$domain_backend" '
                      'response_time=$request_time';

# ä¸»æœåŠ¡å™¨é…ç½®
server {
    listen 443 ssl http2;
    
    # æ”¯æŒæ‰€æœ‰åŸŸå
    server_name 
        domain1.com www.domain1.com
        domain2.net www.domain2.net
        domain3.org www.domain3.org
        domain4.cc www.domain4.cc;
    
    # SSLé…ç½® (ä½¿ç”¨é€šé…ç¬¦è¯ä¹¦æˆ–å¤šåŸŸåè¯ä¹¦)
    ssl_certificate     /etc/nginx/ssl/multidomain.pem;
    ssl_certificate_key /etc/nginx/ssl/multidomain.key;
    
    root /var/www/html/public;
    index index.php index.html;
    
    # å¥åº·æ£€æŸ¥ä¼˜åŒ– - æ”¯æŒè·¨åŸŸå’Œå›¾ç‰‡æ¢æµ‹
    location = /api/health {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, User-Agent" always;
        add_header Access-Control-Max-Age "86400" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        
        try_files $uri /index.php$is_args$args;
    }
    
    # åŸŸååˆ‡æ¢ç»Ÿè®¡æ¥å£
    location = /api/switch-stats {
        add_header Access-Control-Allow-Origin "*" always;
        try_files $uri /index.php$is_args$args;
    }
    
    # åŸŸååˆ—è¡¨æ¥å£
    location = /api/domain-list {
        add_header Access-Control-Allow-Origin "*" always;
        try_files $uri /index.php$is_args$args;
    }
    
    # å…¶ä»–é…ç½®...
    access_log /var/log/nginx/multidomain.log multidomain;
}
```

---

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### å¤šåŸŸåç›‘æ§è„šæœ¬

åˆ›å»º `scripts/multi-domain-monitor.php`ï¼š

```php
<?php
class MultiDomainMonitor {
    private $domainPools;
    
    public function __construct() {
        $this->domainPools = [
            'primary' => ['domain1.com', 'www.domain1.com'],
            'backup' => ['domain2.net', 'domain3.org'],
            'emergency' => ['domain4.cc']
        ];
    }
    
    public function checkAllDomainPools() {
        $results = [];
        
        foreach ($this->domainPools as $poolName => $domains) {
            $poolResults = [];
            $healthyCount = 0;
            
            foreach ($domains as $domain) {
                $result = $this->checkDomain($domain);
                $poolResults[$domain] = $result;
                
                if ($result['healthy']) {
                    $healthyCount++;
                }
            }
            
            $results[$poolName] = [
                'domains' => $poolResults,
                'healthy_count' => $healthyCount,
                'total_count' => count($domains),
                'pool_healthy' => $healthyCount > 0
            ];
        }
        
        return $results;
    }
    
    public function generateMultiDomainReport() {
        $results = $this->checkAllDomainPools();
        
        $report = [
            'timestamp' => date('Y-m-d H:i:s'),
            'pools' => $results,
            'summary' => [
                'total_pools' => count($this->domainPools),
                'healthy_pools' => 0,
                'total_domains' => 0,
                'healthy_domains' => 0
            ]
        ];
        
        foreach ($results as $poolName => $poolData) {
            if ($poolData['pool_healthy']) {
                $report['summary']['healthy_pools']++;
            }
            $report['summary']['total_domains'] += $poolData['total_count'];
            $report['summary']['healthy_domains'] += $poolData['healthy_count'];
        }
        
        return $report;
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å¤šåŸŸåé…ç½®éªŒè¯

- [ ] **Cloudflareé…ç½®**
  - [ ] æ‰€æœ‰åŸŸåå·²æ·»åŠ åˆ°Cloudflare
  - [ ] æ¯ä¸ªåŸŸåéƒ½æœ‰å¥åº·æ£€æŸ¥
  - [ ] è´Ÿè½½å‡è¡¡å™¨æ­£ç¡®é…ç½®
  
- [ ] **æœåŠ¡ç«¯é…ç½®**
  - [ ] Nginxæ”¯æŒæ‰€æœ‰åŸŸå
  - [ ] SSLè¯ä¹¦è¦†ç›–æ‰€æœ‰åŸŸå
  - [ ] å¥åº·æ£€æŸ¥APIæ”¯æŒè·¨åŸŸ
  
- [ ] **å®¢æˆ·ç«¯é…ç½®**
  - [ ] JSåˆ‡æ¢å™¨åŒ…å«æ‰€æœ‰åŸŸå
  - [ ] è·¨åŸŸå¥åº·æ£€æŸ¥æ­£å¸¸
  - [ ] çŠ¶æ€æ¢å¤åŠŸèƒ½æ­£å¸¸

### æµ‹è¯•æ­¥éª¤

1. **å•åŸŸåæµ‹è¯•**: ç¡®ä¿æ¯ä¸ªåŸŸåç‹¬ç«‹å·¥ä½œ
2. **è·¨åŸŸååˆ‡æ¢æµ‹è¯•**: æ¨¡æ‹ŸåŸŸåæ•…éšœ
3. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´çš„ç”¨æˆ·ä½“éªŒæµ‹è¯•

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### åŸŸåé€‰æ‹©ç­–ç•¥
1. **ä¸»åŸŸåæ± **: ä½¿ç”¨æœ€å¯é çš„åŸŸå
2. **å¤‡ç”¨åŸŸåæ± **: ä¸åŒTLDå’Œæ³¨å†Œå•†
3. **ç´§æ€¥åŸŸåæ± **: é¢„ç•™çš„ç´§æ€¥åŸŸå

### æ€§èƒ½ä¼˜åŒ–
1. **DNSé¢„è§£æ**: `<link rel="dns-prefetch" href="//domain2.net">`
2. **åŸŸåé¢„è¿æ¥**: `<link rel="preconnect" href="//domain3.org">`
3. **æ™ºèƒ½æ£€æŸ¥é—´éš”**: æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´æ£€æŸ¥é¢‘ç‡

### å®‰å…¨è€ƒè™‘
1. **HTTPSå¼ºåˆ¶**: æ‰€æœ‰åŸŸåå¿…é¡»æ”¯æŒHTTPS
2. **CORSç­–ç•¥**: åˆç†é…ç½®è·¨åŸŸè®¿é—®
3. **æ—¥å¿—å®¡è®¡**: è®°å½•æ‰€æœ‰åŸŸååˆ‡æ¢è¡Œä¸º

## ğŸš€ å¿«é€Ÿå†³ç­–æŒ‡å—

### æˆ‘åº”è¯¥é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

#### é€‰æ‹©å•åŸŸåæ–¹æ¡ˆï¼ˆdoc/9.CFé…ç½®.mdï¼‰å¦‚æœï¼š
- âœ… æ‚¨åªæœ‰**ä¸€ä¸ªä¸»åŸŸå**ï¼ˆå¦‚ yourdomain.comï¼‰
- âœ… å¸Œæœ›åœ¨**å­åŸŸåé—´åˆ‡æ¢**ï¼ˆmain.yourdomain.com â†” backup1.yourdomain.comï¼‰
- âœ… å¸Œæœ›**é…ç½®ç®€å•**ï¼Œå¿«é€Ÿéƒ¨ç½²
- âœ… åŸŸåç®¡ç†åœ¨**åŒä¸€ä¸ªCloudflareè´¦æˆ·**

#### é€‰æ‹©å¤šåŸŸåæ–¹æ¡ˆï¼ˆæœ¬æ–‡æ¡£ï¼‰å¦‚æœï¼š
- ğŸŒ æ‚¨æœ‰**å¤šä¸ªå®Œå…¨ä¸åŒçš„åŸŸå**ï¼ˆdomain1.com, domain2.net, domain3.orgï¼‰
- ğŸŒ éœ€è¦**è·¨TLDçš„æ•…éšœè½¬ç§»**ï¼ˆ.com â†” .net â†” .orgï¼‰
- ğŸŒ å¸Œæœ›**æ›´å¼ºçš„æŠ—å°é”èƒ½åŠ›**
- ğŸŒ åŸŸååˆ†å¸ƒåœ¨**ä¸åŒæ³¨å†Œå•†æˆ–Cloudflareè´¦æˆ·**

#### ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | å•åŸŸåæ–¹æ¡ˆ | å¤šåŸŸåæ–¹æ¡ˆ |
|------|-----------|-----------|
| é…ç½®å¤æ‚åº¦ | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸­ç­‰ |
| æŠ—å°é”èƒ½åŠ› | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å¼º |
| åˆ‡æ¢é€Ÿåº¦ | ğŸŸ¢ å¿«ï¼ˆ1-3åˆ†é’Ÿï¼‰ | ğŸŸ¡ è¾ƒå¿«ï¼ˆ1-5åˆ†é’Ÿï¼‰ |
| ç»´æŠ¤æˆæœ¬ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ç­‰ |
| é€‚ç”¨è§„æ¨¡ | ğŸŸ¡ å°-ä¸­å‹é¡¹ç›® | ğŸŸ¢ ä¸­-å¤§å‹é¡¹ç›® |

### å®æ–½å»ºè®®

1. **èµ·æ­¥é˜¶æ®µ**: å¦‚æœåˆšå¼€å§‹ï¼Œå»ºè®®å…ˆä½¿ç”¨**å•åŸŸåæ–¹æ¡ˆ**
2. **æˆé•¿é˜¶æ®µ**: å½“ä¸šåŠ¡ç¨³å®šåï¼Œå¯å‡çº§åˆ°**å¤šåŸŸåæ–¹æ¡ˆ**
3. **æˆç†Ÿé˜¶æ®µ**: å¤§å‹é¡¹ç›®ç›´æ¥ä½¿ç”¨**å¤šåŸŸåæ–¹æ¡ˆ**

---

**âœ¨ è¿™ä¸ªå®Œæ•´çš„å¤šåŸŸåæ–¹æ¡ˆå°† `8.åŸŸåå“åº”æ–¹æ¡ˆ.md` å’Œ `9.CFé…ç½®.md` å®Œç¾æ•´åˆï¼Œæ”¯æŒå¤šä¸ªå®Œå…¨ä¸åŒçš„åŸŸåï¼Œå®ç°çœŸæ­£çš„ä¼ä¸šçº§åŸŸååŠ¨æ€åˆ‡æ¢ç³»ç»Ÿï¼** 